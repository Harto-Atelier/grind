<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sat Mining | Harto Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap');
    body { font-family: 'JetBrains Mono', monospace; background: #0a0a0a; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes slideIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .animate-pulse-slow { animation: pulse 2s ease-in-out infinite; }
    .opp-card { transition: all 0.2s; animation: slideIn 0.3s ease-out; }
    .opp-card:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(34,197,94,0.1); }
    #scanLog::-webkit-scrollbar { width: 4px; }
    #scanLog::-webkit-scrollbar-thumb { background: #f59e0b33; border-radius: 2px; }
    .speed-badge { font-variant-numeric: tabular-nums; }
  </style>
</head>
<body class="min-h-screen text-gray-100">
  <header class="border-b border-amber-500/30 bg-amber-500/5">
    <div class="max-w-6xl mx-auto px-4 py-6">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <div class="p-3 bg-amber-500/20 rounded-lg border border-amber-500/30">
            <span class="text-3xl">‚õèÔ∏è</span>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-amber-400">SAT MINING</h1>
            <p class="text-sm text-gray-500">UTXO Arbitrage Scanner ¬∑ <span class="text-amber-400/60">v2 turbo</span></p>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <button onclick="clearCache()" class="px-2 py-1 text-[10px] bg-gray-800 hover:bg-gray-700 text-gray-400 border border-gray-700 rounded transition-all cursor-pointer" title="Limpiar cach√©">üóëÔ∏è Cache</button>
          <span id="cacheCount" class="text-[10px] text-gray-600"></span>
          <span class="px-2 py-1 text-xs bg-amber-500/20 text-amber-400 border border-amber-500/30 rounded">üîí INTERNAL</span>
          <a href="index.html" class="text-xs text-gray-500 hover:text-amber-400 transition-colors">‚Üê Dashboard</a>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8">
    <div class="p-4 border border-amber-500/30 bg-amber-500/5 mb-6 rounded-lg">
      <p class="text-sm text-gray-200">
        Escanea <span class="text-amber-400 font-bold">todos los listings de Magic Eden</span> ordenados por menor precio.
        <span class="text-green-400">3x paralelo</span> + cach√© local = mucho m√°s r√°pido.
      </p>
    </div>

    <!-- Controls -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <div class="p-4 border border-gray-800 bg-black/30 rounded-lg space-y-3">
        <h3 class="text-xs text-gray-500 uppercase font-bold">Filtros</h3>
        <div class="flex flex-wrap gap-3">
          <div>
            <label class="text-[10px] text-gray-500 block mb-1">Colecci√≥n (vac√≠o = todas)</label>
            <input type="text" id="collectionSlug" value="" placeholder="Todas las colecciones" 
              class="px-3 py-2 bg-gray-900 border border-gray-700 focus:border-amber-500/50 rounded text-sm text-gray-200 w-44 outline-none">
          </div>
          <div>
            <label class="text-[10px] text-gray-500 block mb-1">Precio m√≠n</label>
            <input type="number" id="minPrice" value="546" 
              class="px-3 py-2 bg-gray-900 border border-gray-700 focus:border-amber-500/50 rounded text-sm text-gray-200 w-28 outline-none">
          </div>
          <div>
            <label class="text-[10px] text-gray-500 block mb-1">Precio m√°x</label>
            <input type="number" id="maxPrice" value="50000" 
              class="px-3 py-2 bg-gray-900 border border-gray-700 focus:border-amber-500/50 rounded text-sm text-gray-200 w-28 outline-none">
          </div>
          <div>
            <label class="text-[10px] text-gray-500 block mb-1">P√°ginas</label>
            <input type="number" id="maxPages" value="10" min="1" max="50"
              class="px-3 py-2 bg-gray-900 border border-gray-700 focus:border-amber-500/50 rounded text-sm text-gray-200 w-20 outline-none">
          </div>
          <div>
            <label class="text-[10px] text-gray-500 block mb-1">Paralelo</label>
            <select id="concurrency" class="px-3 py-2 bg-gray-900 border border-gray-700 focus:border-amber-500/50 rounded text-sm text-gray-200 w-20 outline-none">
              <option value="1">√ó1</option>
              <option value="3" selected>√ó3</option>
              <option value="5">√ó5</option>
              <option value="8">√ó8</option>
            </select>
          </div>
        </div>
        <!-- Quick presets -->
        <div class="flex flex-wrap gap-2 pt-1">
          <span class="text-[10px] text-gray-600">Quick:</span>
          <button onclick="setPreset('',546,50000,10)" class="px-2 py-0.5 text-[10px] bg-amber-500/10 hover:bg-amber-500/20 text-amber-400 border border-amber-500/20 rounded cursor-pointer">Todo &lt;50k</button>
          <button onclick="setPreset('',546,10000,20)" class="px-2 py-0.5 text-[10px] bg-amber-500/10 hover:bg-amber-500/20 text-amber-400 border border-amber-500/20 rounded cursor-pointer">Todo &lt;10k</button>
          <button onclick="setPreset('exquisite',546,50000,10)" class="px-2 py-0.5 text-[10px] bg-amber-500/10 hover:bg-amber-500/20 text-amber-400 border border-amber-500/20 rounded cursor-pointer">Exquisite</button>
          <button onclick="setPreset('bitcoin-frogs',546,100000,10)" class="px-2 py-0.5 text-[10px] bg-amber-500/10 hover:bg-amber-500/20 text-amber-400 border border-amber-500/20 rounded cursor-pointer">BTC Frogs</button>
          <button onclick="setPreset('nodemonkes',546,100000,10)" class="px-2 py-0.5 text-[10px] bg-amber-500/10 hover:bg-amber-500/20 text-amber-400 border border-amber-500/20 rounded cursor-pointer">NodeMonkes</button>
        </div>
      </div>
      <div class="p-4 border border-gray-800 bg-black/30 rounded-lg flex flex-col justify-between">
        <h3 class="text-xs text-gray-500 uppercase font-bold mb-3">Acci√≥n</h3>
        <div class="flex items-center gap-3">
          <button id="scanBtn" onclick="startScan()"
            class="flex-1 flex items-center justify-center gap-2 px-6 py-3 bg-amber-500/20 hover:bg-amber-500/30 border border-amber-500/50 text-amber-400 text-sm uppercase font-bold transition-all disabled:opacity-50 rounded-lg cursor-pointer">
            <span id="scanText">‚õèÔ∏è ESCANEAR</span>
          </button>
          <button onclick="stopScan()" id="stopBtn"
            class="px-4 py-3 bg-red-500/20 hover:bg-red-500/30 border border-red-500/50 text-red-400 text-sm transition-all rounded-lg hidden cursor-pointer">
            ‚èπ
          </button>
        </div>
        <div class="flex justify-between mt-2">
          <p class="text-[10px] text-gray-600">20/p√°gina ¬∑ paralelo configurable ¬∑ cach√© 24h</p>
          <p class="text-[10px] text-gray-600 speed-badge" id="speedInfo"></p>
        </div>
      </div>
    </div>

    <!-- Stats Grid -->
    <div id="statsGrid" class="grid grid-cols-3 md:grid-cols-6 gap-3 mb-6 hidden">
      <div class="p-3 border border-amber-500/30 bg-black/30 rounded-lg text-center">
        <p class="text-[10px] text-gray-500 uppercase">Listings</p>
        <p id="statListings" class="text-xl font-bold text-amber-400 speed-badge">0</p>
      </div>
      <div class="p-3 border border-amber-500/30 bg-black/30 rounded-lg text-center">
        <p class="text-[10px] text-gray-500 uppercase">Checked</p>
        <p id="statChecked" class="text-xl font-bold text-gray-300 speed-badge">0</p>
      </div>
      <div class="p-3 border border-blue-500/30 bg-black/30 rounded-lg text-center">
        <p class="text-[10px] text-gray-500 uppercase">Cached</p>
        <p id="statCached" class="text-xl font-bold text-blue-400 speed-badge">0</p>
      </div>
      <div class="p-3 border border-green-500/30 bg-black/30 rounded-lg text-center">
        <p class="text-[10px] text-gray-500 uppercase">Opps</p>
        <p id="statOpps" class="text-xl font-bold text-green-400 speed-badge">0</p>
      </div>
      <div class="p-3 border border-green-500/30 bg-black/30 rounded-lg text-center">
        <p class="text-[10px] text-gray-500 uppercase">Mejor</p>
        <p id="statBest" class="text-xl font-bold text-green-400 speed-badge">‚Äî</p>
      </div>
      <div class="p-3 border border-amber-500/30 bg-black/30 rounded-lg text-center">
        <p class="text-[10px] text-gray-500 uppercase">ETA</p>
        <p id="statEta" class="text-lg font-bold text-amber-400 speed-badge">‚Äî</p>
      </div>
    </div>

    <!-- Progress -->
    <div id="progressBar" class="mb-4 hidden">
      <div class="flex justify-between text-xs text-gray-500 mb-1">
        <span id="progressText">Escaneando...</span>
        <span id="progressPct">0%</span>
      </div>
      <div class="w-full bg-gray-800 rounded-full h-1.5">
        <div id="progressFill" class="bg-gradient-to-r from-amber-500 to-green-500 h-1.5 rounded-full transition-all duration-300" style="width: 0%"></div>
      </div>
    </div>

    <!-- Log -->
    <div id="scanLog" class="mb-6 p-3 border border-gray-800 bg-black/50 rounded-lg max-h-36 overflow-y-auto text-[11px] text-gray-500 font-mono hidden"></div>

    <!-- Empty State -->
    <div id="emptyState" class="flex items-center justify-center py-20 border border-dashed border-amber-500/30 rounded-lg">
      <div class="text-center space-y-4">
        <span class="text-5xl">‚õèÔ∏è</span>
        <p class="text-sm text-gray-400">Pulsa "Escanear" para buscar oportunidades</p>
        <p class="text-xs text-gray-600">Todas las colecciones ¬∑ Menor precio ¬∑ Checks paralelos</p>
      </div>
    </div>

    <!-- Results -->
    <div id="resultsSection" class="hidden">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-sm font-bold text-green-400">üí∞ Oportunidades</h2>
        <div class="flex items-center gap-3">
          <span id="resultCount" class="text-xs text-gray-500"></span>
          <span id="totalProfit" class="text-xs text-green-400 font-bold"></span>
        </div>
      </div>
      <div id="resultsList" class="space-y-2"></div>
    </div>

    <!-- All Listings Table -->
    <div id="allListingsSection" class="mt-6 hidden">
      <details>
        <summary class="text-sm font-bold text-gray-400 cursor-pointer hover:text-amber-400 transition-colors">
          üìã Todos los listings escaneados (<span id="allListingsCount">0</span>)
        </summary>
        <div id="allListingsTable" class="mt-3 space-y-1 max-h-96 overflow-y-auto"></div>
      </details>
    </div>

    <!-- How It Works -->
    <div class="mt-8 p-4 border border-amber-500/20 bg-black/30 rounded-lg">
      <h3 class="font-bold text-amber-400 text-sm mb-3">‚õèÔ∏è C√ìMO FUNCIONA</h3>
      <ul class="space-y-2 text-xs text-gray-400">
        <li><span class="text-amber-400">1.</span> Busca los listings m√°s baratos en Magic Eden (todas o una colecci√≥n)</li>
        <li><span class="text-amber-400">2.</span> Comprueba el UTXO real de cada inscripci√≥n (√ó3 paralelo + cach√© 24h)</li>
        <li><span class="text-amber-400">3.</span> Si UTXO > precio + fee ‚Üí <span class="text-green-400">oportunidad</span></li>
        <li><span class="text-amber-400">4.</span> Compras ‚Üí <code class="text-amber-400 bg-amber-500/10 px-1 rounded">ord wallet split</code> ‚Üí profit</li>
      </ul>
      <p class="text-[10px] text-amber-400/60 mt-3">‚ö†Ô∏è DYOR ¬∑ Split fee ~750 sats ¬∑ Min profit: 1000 sats ¬∑ Cach√© 24h en localStorage</p>
    </div>
  </main>

  <script>
    const SPLIT_FEE = 750;
    const MIN_PROFIT = 1000;
    const CACHE_TTL = 24 * 60 * 60 * 1000; // 24h
    let scanning = false;
    let shouldStop = false;
    let scanStart = 0;

    // === CACHE ===
    function getCache() {
      try { return JSON.parse(localStorage.getItem('mining-cache') || '{}'); } catch { return {}; }
    }
    function setCache(cache) { localStorage.setItem('mining-cache', JSON.stringify(cache)); }
    function getCachedValue(id) {
      const c = getCache();
      if (c[id] && Date.now() - c[id].t < CACHE_TTL) return c[id].v;
      return undefined;
    }
    function setCachedValue(id, val) {
      const c = getCache();
      c[id] = { v: val, t: Date.now() };
      setCache(c);
    }
    function clearCache() {
      localStorage.removeItem('mining-cache');
      updateCacheCount();
      log('üóëÔ∏è Cach√© limpiado', 'warn');
    }
    function updateCacheCount() {
      const c = getCache();
      const count = Object.keys(c).length;
      document.getElementById('cacheCount').textContent = count > 0 ? `${count} cached` : '';
    }

    // === UI ===
    function log(msg, type = 'info') {
      const el = document.getElementById('scanLog');
      el.classList.remove('hidden');
      const time = new Date().toLocaleTimeString('es-ES', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
      const colors = { info: 'text-gray-600', ok: 'text-green-400', warn: 'text-amber-400', error: 'text-red-400', cache: 'text-blue-400' };
      el.innerHTML += `<div class="${colors[type] || colors.info}">[${time}] ${msg}</div>`;
      el.scrollTop = el.scrollHeight;
    }

    function fmt(s) {
      if (s >= 1000000) return (s/1000000).toFixed(2) + 'M';
      if (s >= 1000) return (s/1000).toFixed(1) + 'k';
      return s.toLocaleString();
    }

    function updateProgress(current, total, text) {
      const pct = total > 0 ? Math.round((current / total) * 100) : 0;
      document.getElementById('progressFill').style.width = pct + '%';
      document.getElementById('progressPct').textContent = pct + '%';
      if (text) document.getElementById('progressText').textContent = text;
    }

    function updateEta(checked, total) {
      if (checked < 3) { document.getElementById('statEta').textContent = '...'; return; }
      const elapsed = (Date.now() - scanStart) / 1000;
      const rate = checked / elapsed;
      const remaining = (total - checked) / rate;
      const mins = Math.floor(remaining / 60);
      const secs = Math.floor(remaining % 60);
      document.getElementById('statEta').textContent = mins > 0 ? `${mins}m${secs}s` : `${secs}s`;
      document.getElementById('speedInfo').textContent = `${rate.toFixed(1)}/s`;
    }

    function setPreset(slug, min, max, pages) {
      document.getElementById('collectionSlug').value = slug;
      document.getElementById('minPrice').value = min;
      document.getElementById('maxPrice').value = max;
      document.getElementById('maxPages').value = pages;
    }

    async function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

    function stopScan() {
      shouldStop = true;
      document.getElementById('statEta').textContent = '‚èπ';
      log('‚èπ Detenido', 'warn');
    }

    // === API ===
    async function fetchWithRetry(url, retries = 3) {
      for (let i = 0; i < retries; i++) {
        try {
          const res = await fetch(url);
          if (res.ok) return await res.json();
          if (res.status === 429) {
            const wait = (i + 1) * 10000;
            log(`‚è≥ Rate limit ‚Äî ${wait/1000}s...`, 'warn');
            await sleep(wait);
          } else {
            throw new Error(`HTTP ${res.status}`);
          }
        } catch (e) {
          if (i === retries - 1) throw e;
          await sleep(3000);
        }
      }
      return null;
    }

    async function fetchListings(slug, minPrice, maxPrice, maxPages) {
      const listings = [];
      const limit = 20;
      for (let page = 0; page < maxPages; page++) {
        if (shouldStop) break;
        const offset = page * limit;
        let url = `/api/me/v2/ord/btc/tokens?sortBy=priceAsc&limit=${limit}&offset=${offset}&minPrice=${minPrice}&maxPrice=${maxPrice}`;
        if (slug) url += `&collectionSymbol=${slug}`;
        log(`üìÑ P√°g ${page + 1}/${maxPages}...`);
        try {
          const data = await fetchWithRetry(url);
          if (!data) { log('‚ùå Sin datos', 'error'); break; }
          const tokens = data.tokens || data || [];
          if (!Array.isArray(tokens) || tokens.length === 0) { log(`üìÑ P√°g ${page + 1}: vac√≠a`, 'warn'); break; }
          tokens.forEach(t => {
            const price = t.listedPrice;
            if (price && price >= minPrice && price <= maxPrice) {
              listings.push({
                id: t.id,
                name: t.meta?.name || t.id?.substring(0, 16) + '...',
                collection: t.collection?.name || t.collectionSymbol || '‚Äî',
                price: price,
                imageUrl: t.contentURI || t.meta?.imageURI || '',
              });
            }
          });
          document.getElementById('statListings').textContent = listings.length;
          log(`‚úÖ +${tokens.length} (total: ${listings.length})`, 'ok');
          if (tokens.length < limit) break;
          await sleep(1200);
        } catch (e) {
          log(`‚ùå ${e.message}`, 'error');
          await sleep(5000);
        }
      }
      return listings;
    }

    async function getOutputValue(inscriptionId) {
      // Check cache first
      const cached = getCachedValue(inscriptionId);
      if (cached !== undefined) return cached;
      
      try {
        const data = await fetchWithRetry(`/api/hiro/ordinals/v1/inscriptions/${inscriptionId}`);
        if (data && (data.value || data.output_value)) {
          const val = parseInt(data.value || data.output_value);
          setCachedValue(inscriptionId, val);
          return val;
        }
      } catch (e) {}
      setCachedValue(inscriptionId, null);
      return null;
    }

    // === PARALLEL CHECKER ===
    async function checkBatch(items, onResult) {
      const results = await Promise.allSettled(
        items.map(async (item) => {
          const outputValue = await getOutputValue(item.id);
          return { item, outputValue };
        })
      );
      for (const r of results) {
        if (r.status === 'fulfilled') onResult(r.value);
      }
    }

    // === RENDER ===
    function renderOpportunity(opp, idx) {
      const card = document.createElement('a');
      card.href = `https://magiceden.io/ordinals/item-details/${opp.id}`;
      card.target = '_blank';
      card.className = 'opp-card block p-4 border border-green-500/30 hover:border-green-500/60 hover:bg-green-500/5 rounded-lg group';
      card.innerHTML = `
        <div class="flex items-center justify-between gap-4">
          <div class="flex items-center gap-3 min-w-0">
            <span class="text-lg font-bold text-green-400/60 w-7 flex-shrink-0">#${idx}</span>
            ${opp.imageUrl ? `<img src="${opp.imageUrl}" class="w-12 h-12 rounded object-cover bg-gray-800 flex-shrink-0" loading="lazy" onerror="this.style.display='none'">` : ''}
            <div class="min-w-0">
              <p class="font-bold text-gray-200 group-hover:text-green-400 transition-colors text-sm truncate">${opp.name}</p>
              <p class="text-[10px] text-gray-500 truncate">${opp.collection}</p>
              <span class="inline-block mt-1 px-2 py-0.5 bg-green-500/20 text-green-400 border border-green-500/30 text-xs font-bold rounded">+${fmt(opp.profit)} sats</span>
            </div>
          </div>
          <div class="text-right flex-shrink-0 text-xs space-y-1">
            <p class="text-gray-500">UTXO: <span class="text-gray-300 font-bold">${fmt(opp.outputValue)}</span></p>
            <p class="text-gray-500">Precio: <span class="text-amber-400">${fmt(opp.price)}</span></p>
            <p class="text-green-400 font-bold text-sm">+${fmt(opp.profit)}</p>
          </div>
        </div>`;
      return card;
    }

    function renderAllListing(item, outputValue) {
      const profit = outputValue !== null ? outputValue - item.price - SPLIT_FEE : null;
      const profitColor = profit === null ? 'text-gray-600' : profit > MIN_PROFIT ? 'text-green-400' : profit > 0 ? 'text-amber-400' : 'text-gray-600';
      const profitText = profit === null ? '?' : (profit > 0 ? '+' : '') + fmt(profit);
      const el = document.createElement('div');
      el.className = 'flex items-center justify-between px-3 py-1.5 text-[11px] border-b border-gray-800/50 hover:bg-gray-800/30';
      el.innerHTML = `
        <div class="flex items-center gap-2 min-w-0 flex-1">
          <span class="text-gray-600 w-24 truncate flex-shrink-0">${item.collection}</span>
          <a href="https://magiceden.io/ordinals/item-details/${item.id}" target="_blank" class="text-gray-400 hover:text-amber-400 truncate">${item.name}</a>
        </div>
        <div class="flex items-center gap-4 flex-shrink-0">
          <span class="text-amber-400 w-16 text-right">${fmt(item.price)}</span>
          <span class="text-gray-400 w-16 text-right">${outputValue !== null ? fmt(outputValue) : '‚Äî'}</span>
          <span class="${profitColor} w-16 text-right font-bold">${profitText}</span>
        </div>`;
      return el;
    }

    // === MAIN SCAN ===
    async function startScan() {
      if (scanning) return;
      scanning = true;
      shouldStop = false;
      scanStart = Date.now();

      const slug = document.getElementById('collectionSlug').value.trim();
      const minPrice = parseInt(document.getElementById('minPrice').value) || 546;
      const maxPrice = parseInt(document.getElementById('maxPrice').value) || 50000;
      const maxPages = parseInt(document.getElementById('maxPages').value) || 10;
      const concurrency = parseInt(document.getElementById('concurrency').value) || 3;

      // Reset UI
      document.getElementById('scanBtn').disabled = true;
      document.getElementById('stopBtn').classList.remove('hidden');
      document.getElementById('scanText').textContent = '‚è≥ Escaneando...';
      document.getElementById('emptyState').classList.add('hidden');
      document.getElementById('resultsSection').classList.add('hidden');
      document.getElementById('allListingsSection').classList.add('hidden');
      document.getElementById('resultsList').innerHTML = '';
      document.getElementById('statsGrid').classList.remove('hidden');
      document.getElementById('progressBar').classList.remove('hidden');
      document.getElementById('scanLog').innerHTML = '';
      document.getElementById('scanLog').classList.remove('hidden');
      ['statListings','statChecked','statCached','statOpps'].forEach(id => document.getElementById(id).textContent = '0');
      document.getElementById('statBest').textContent = '‚Äî';
      document.getElementById('statEta').textContent = '...';
      document.getElementById('speedInfo').textContent = '';

      const mode = slug ? `"${slug}"` : 'TODAS';
      log(`üöÄ ${mode} | ${fmt(minPrice)}-${fmt(maxPrice)} sats | ${maxPages}p | √ó${concurrency}`, 'ok');

      // Step 1: Fetch listings
      const listings = await fetchListings(slug, minPrice, maxPrice, maxPages);
      if (listings.length === 0 || shouldStop) {
        document.getElementById('statEta').textContent = shouldStop ? '‚èπ' : '‚Äî';
        log(shouldStop ? '‚èπ' : '‚ö†Ô∏è Sin listings', 'warn');
        resetUI(); return;
      }

      // Step 2: Parallel UTXO checks
      log(`\nüîç Checking ${listings.length} UTXOs (√ó${concurrency} paralelo)...`, 'ok');

      const opportunities = [];
      const allResults = [];
      let checked = 0, cached = 0, bestProfit = 0;

      // Process in batches
      for (let i = 0; i < listings.length; i += concurrency) {
        if (shouldStop) break;
        const batch = listings.slice(i, i + concurrency);
        
        await checkBatch(batch, ({ item, outputValue }) => {
          checked++;
          const wasCached = getCachedValue(item.id) !== undefined;
          if (wasCached) cached++;
          
          document.getElementById('statChecked').textContent = checked;
          document.getElementById('statCached').textContent = cached;
          updateProgress(checked, listings.length, `${checked}/${listings.length}`);
          updateEta(checked, listings.length);

          allResults.push({ item, outputValue });

          if (outputValue !== null) {
            const profit = outputValue - item.price - SPLIT_FEE;
            if (profit > MIN_PROFIT) {
              const opp = { ...item, outputValue, profit };
              opportunities.push(opp);
              opportunities.sort((a, b) => b.profit - a.profit);
              if (profit > bestProfit) bestProfit = profit;
              document.getElementById('statOpps').textContent = opportunities.length;
              document.getElementById('statBest').textContent = fmt(bestProfit);
              log(`üí∞ ${item.name} (${item.collection}) ‚Üí +${fmt(profit)}`, 'ok');

              // Re-render sorted
              document.getElementById('resultsSection').classList.remove('hidden');
              const list = document.getElementById('resultsList');
              list.innerHTML = '';
              opportunities.forEach((o, idx) => list.appendChild(renderOpportunity(o, idx + 1)));
              const total = opportunities.reduce((s, o) => s + o.profit, 0);
              document.getElementById('resultCount').textContent = `${opportunities.length} encontradas`;
              document.getElementById('totalProfit').textContent = `Total: +${fmt(total)} sats`;
            }
          }
        });

        // Small delay between batches (not between individual requests)
        if (i + concurrency < listings.length && !shouldStop) await sleep(800);
      }

      // Done
      updateProgress(1, 1, '¬°Completado!');
      const elapsed = ((Date.now() - scanStart) / 1000).toFixed(1);
      document.getElementById('statEta').textContent = '‚úÖ';
      document.getElementById('speedInfo').textContent = `${elapsed}s total`;
      
      const totalProfit = opportunities.reduce((s, o) => s + o.profit, 0);
      log(`\n‚úÖ Listo en ${elapsed}s: ${checked} checked, ${cached} cached, ${opportunities.length} opps, +${fmt(totalProfit)} sats potencial`, 'ok');

      // Render all listings table
      if (allResults.length > 0) {
        const section = document.getElementById('allListingsSection');
        section.classList.remove('hidden');
        document.getElementById('allListingsCount').textContent = allResults.length;
        const table = document.getElementById('allListingsTable');
        table.innerHTML = '<div class="flex items-center justify-between px-3 py-1 text-[10px] text-gray-600 uppercase border-b border-gray-700"><div class="flex items-center gap-2 flex-1"><span class="w-24">Colecci√≥n</span><span>Nombre</span></div><div class="flex items-center gap-4"><span class="w-16 text-right">Precio</span><span class="w-16 text-right">UTXO</span><span class="w-16 text-right">Profit</span></div></div>';
        allResults.sort((a, b) => {
          const pa = a.outputValue ? a.outputValue - a.item.price - SPLIT_FEE : -Infinity;
          const pb = b.outputValue ? b.outputValue - b.item.price - SPLIT_FEE : -Infinity;
          return pb - pa;
        });
        allResults.forEach(r => table.appendChild(renderAllListing(r.item, r.outputValue)));
      }

      if (opportunities.length === 0 && !shouldStop) {
        document.getElementById('emptyState').classList.remove('hidden');
        document.getElementById('emptyState').querySelector('p').textContent = 'No se encontraron oportunidades';
      }

      updateCacheCount();
      resetUI();
    }

    function resetUI() {
      document.getElementById('scanBtn').disabled = false;
      document.getElementById('stopBtn').classList.add('hidden');
      document.getElementById('scanText').textContent = '‚õèÔ∏è ESCANEAR';
      scanning = false;
      shouldStop = false;
    }

    // Init
    updateCacheCount();
  </script>
</body>
</html>
